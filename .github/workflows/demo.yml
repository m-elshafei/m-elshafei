name: Create and Merge Pull Request

on:
  push:
    branches:
      - develop

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Git
        run: |
          git config --global user.name 'Moustafa Elshafei'
          git config --global user.email 'moustafaelshafhy@gmail.com'

      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install gh

      - name: Authenticate GitHub CLI
        run: |
          echo "${{ secrets.MY_GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Create a Pull Request from develop to main
        id: pr
        run: |
          gh pr create --base main --head develop --title "Sync develop to main" --body "Automated pull request to merge develop into main" || echo "Failed to create PR"

      - name: List Open Pull Requests
        run: |
          gh pr list --state open --base main --head develop
          
      - name: Merge Pull Request
        run: |
          PR_NUMBER=$(gh pr list --state open --base main --head develop --json number --jq '.[0].number')
          if [ -n "$PR_NUMBER" ]; then
            gh pr merge "$PR_NUMBER" --merge --delete-branch || echo "Failed to merge PR"
          else
            echo "No open pull request found to merge."
          fi
